name: Deploy Lambda Function to Production Environment
on:
  push:
    branches: 
      - 'backend-prod'
    paths:
      - 'src/**'
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      # Create layer
      - name: Create layer directory
        run: mkdir -p nodejs

      - name: Copy package files
        run: cp src/package*.json nodejs/

      - name: Install dependencies for layer
        run: cd nodejs && npm install --production

      - name: Zip layer
        run: zip -r layer.zip nodejs/

      # Create and publish layer
      - name: Publish layer
        run: |
          LAYER_VERSION=$(aws lambda publish-layer-version \
            --layer-name BirdieAI_dependencies \
            --zip-file fileb://layer.zip \
            --compatible-runtimes nodejs22.x \
            --output text --query Version)
          
          # Update function to use new layer
          aws lambda update-function-configuration \
            --function-name arn:aws:lambda:us-east-2:905418150893:function:birdieAI-backend-prod \
            --layers "arn:aws:lambda:us-east-2:905418150893:layer:BirdieAI_dependencies:$LAYER_VERSION"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          AWS_DEFAULT_REGION: "us-east-2"

      # Deploy function code (without node_modules)
      - name: Create Zip file for Lambda function
        run: cd src && zip -r code.zip . -x "node_modules/*"
        
      - name: Update function code
        run: |
          aws lambda update-function-code \
            --function-name arn:aws:lambda:us-east-2:905418150893:function:birdieAI-backend-prod \
            --zip-file fileb://src/code.zip
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID_PROD }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY_PROD }}
          AWS_DEFAULT_REGION: "us-east-2"
